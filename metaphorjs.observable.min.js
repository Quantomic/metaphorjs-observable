(function(){"undefined"==typeof window&&(global.window=global);if(window.Promise)l=window.Promise;else{var l;if("undefined"!=typeof global)try{l=require("metaphorjs-promise")}catch(u){global.Promise&&(l=global.Promise)}else window.MetaphorJs&&MetaphorJs.lib&&MetaphorJs.lib.Promise&&(l=MetaphorJs.lib.Promise)}var r=window.MetaphorJs&&MetaphorJs.nextUid?MetaphorJs.nextUid:function(){return Array(11).join((Math.random().toString(36)+"00000000000000000").slice(2,18)).slice(0,10)},p=function(a,b){for(var c in b)b.hasOwnProperty(c)&&
(a[c]=b[c])},n=Array.prototype.slice,s="undefined"!=typeof process?process.nextTick:function(a){window.setTimeout(a,0)},h=function(){this.events={}};p(h.prototype,{createEvent:function(a,b){a=a.toLowerCase();var c=this.events;c[a]||(c[a]=new q(a,b));return c[a]},getEvent:function(a){a=a.toLowerCase();return this.events[a]},on:function(a,b,c,d){a=a.toLowerCase();var e=this.events;e[a]||(e[a]=new q(a));return e[a].on(b,c,d)},once:function(a,b,c,d){d=d||{};d.limit=1;return this.on(a,b,c,d)},un:function(a,
b,c){a=a.toLowerCase();var d=this.events;d[a]&&d[a].un(b,c)},hasListener:function(a,b,c){a=a.toLowerCase();var d=this.events;return d[a]?d[a].hasListener(b,c):!1},removeAllListeners:function(a){var b=this.events;b[a]&&b[a].removeAllListeners()},triggerAsync:function(){var a=arguments[0],b=this.events,a=a.toLowerCase();if(!b[a])return[];a=b[a];return a.triggerAsync.apply(a,n.call(arguments,1))},trigger:function(){var a=arguments[0],b=this.events,a=a.toLowerCase();if(!b[a])return null;a=b[a];return a.trigger.apply(a,
n.call(arguments,1))},suspendEvent:function(a){a=a.toLowerCase();var b=this.events;b[a]&&b[a].suspend()},suspendAllEvents:function(){var a=this.events,b;for(b in a)a[b].suspend()},resumeEvent:function(a){a=a.toLowerCase();var b=this.events;b[a]&&b[a].resume()},resumeAllEvents:function(){var a=this.events,b;for(b in a)a[b].resume()},destroyEvent:function(a){var b=this.events;b[a]&&(b[a].removeAllListeners(),b[a].destroy(),delete b[a])},destroy:function(a){var b=this.events;if(a)a=a.toLowerCase(),b[a]&&
(b[a].destroy(),delete b[a]);else{for(var c in b)b[c].destroy();this.events={}}},getApi:function(){var a=this;if(!a.api){var b={},c;for(c in a)"function"==typeof a[c]&&"destroy"!=c&&"getApi"!=c&&(b[c]=function(b){return function(){return b.apply(a,arguments)}}(a[c]));a.api=b}return a.api}});var q=function(a,b){this.name=a;this.listeners=[];this.map={};this.hash=r();this.uni="$$"+a+"_"+this.hash;this.suspended=!1;this.lid=0;this.returnResult=b||!1};p(q.prototype,{getName:function(){return this.name},
destroy:function(){this.map=this.listeners=null},on:function(a,b,c){if(!a)return null;b=b||null;c=c||{};var d=this.uni,e=b||a;if(e[d]&&!c.allowDupes)return null;var f=++this.lid,g=c.first||!1;e[d]=f;a={fn:a,scope:b,uniScope:e,id:f,called:0,limit:c.limit||0,start:c.start||1,count:0,append:c.append,prepend:c.prepend};g?this.listeners.unshift(a):this.listeners.push(a);this.map[f]=a;return f},once:function(a,b,c){c=c||{};c.once=!0;return this.on(a,b,c)},un:function(a,b){var c=-1,d=this.uni,e=this.listeners,
f;f=a==parseInt(a)?a:(b||a)[d];if(!f)return!1;for(var g=0,k=e.length;g<k;g++)if(e[g].id==f){c=g;delete e[g].uniScope[d];break}if(-1==c)return!1;e.splice(c,1);delete this.map[f];return!0},hasListener:function(a,b){var c=this.listeners,d;if(a){b=b||a;d=a==parseInt(a)?a:b[this.uni];if(!d)return!1;for(var e=0,f=c.length;e<f;e++)if(c[e].id==d)return!0;return!1}return 0<c.length},removeAllListeners:function(){var a=this.listeners,b=this.uni,c,d;c=0;for(d=a.length;c<d;c++)delete a[c].uniScope[b];this.listeners=
[];this.map={}},suspend:function(){this.suspended=!0},resume:function(){this.suspended=!1},_prepareArgs:function(a,b){var c;a.append||a.prepend?(c=n.call(b),a.prepend&&(c=a.prepend.concat(c)),a.append&&(c=c.concat(a.append))):c=b;return c},triggerAsync:function(){if("undefined"==typeof l)throw Error("Promises are not defined");var a=this,b=a.listeners,c=a.returnResult,d=n.call(arguments),e=[],f=[],g,k,h;if(a.suspended||0==b.length)return l.resolve(null);k=0;for(h=b.length;k<h;k++)e.push(b[k]);for(k=
function(b){g=a._prepareArgs(b,d);return new l(function(c,d){s(function(){try{c(b.fn.apply(b.scope,g))}catch(e){d(e)}b.called++;b.called==b.limit&&a.un(b.id)},0)})};(b=e.shift())&&(!b||!a.map[b.id]||(b.count++,b.count<b.start||(f.push(k(b)),"first"!=c))););return"last"==c?[f.pop()]:f},trigger:function(){var a=this.listeners,b=this.returnResult;if(this.suspended||0==a.length)return null;var c="all"==b?[]:null,d=[],e,f;if("first"==b)d.push(a[0]);else for(e=0,f=a.length;e<f;e++)d.push(a[e]);for(;a=d.shift();)if(a&&
this.map[a.id]&&(a.count++,!(a.count<a.start))){e=a.fn.apply(a.scope,this._prepareArgs(a,arguments));a.called++;a.called==a.limit&&this.un(a.id);"all"==b&&c.push(e);if("first"==b)return e;"last"==b&&(c=e);if(!1==b&&!1===e)break}if(b)return c}});var m=window.MetaphorJs;if(m&&m.VERSION){var t=new h;p(MetaphorJs,t.getApi())}m&&m.r?m.r("MetaphorJs.lib.Observable",h):(window.MetaphorJs=window.MetaphorJs||{},MetaphorJs.lib=MetaphorJs.lib||{},MetaphorJs.lib.Observable=h);"undefined"!=typeof global&&(module.exports=
h)})();
